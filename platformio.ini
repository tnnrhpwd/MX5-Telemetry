; ============================================================================
; PlatformIO Project Configuration for MX5-Telemetry System
; ============================================================================
; This configuration supports:
; - Arduino Nano (ATmega328P) - Target hardware
; - Native simulation - For testing without hardware
; - Wokwi simulator - For visual simulation with virtual components
; ============================================================================

[platformio]
; Default build environment
; Options: nano_atmega328 (production), nano_release (max performance), 
;          nano_debug (debugging), wokwi_sim (simulator), native_sim (testing)
default_envs = nano_atmega328

; ============================================================================
; ARDUINO NANO - PRODUCTION TARGET
; ============================================================================
[env:nano_atmega328]
platform = atmelavr
board = nanoatmega328
framework = arduino

; Serial monitor configuration
monitor_speed = 115200
monitor_filters = 
    default
    time

; Build flags for production (optimized for size and speed)
build_flags = 
    -DARDUINO_NANO
    -DMCP2515_CRYSTAL_16MHZ
    -Wall
    -Wextra
    ; Optimize for size while maintaining performance
    -Os
    ; Link-time optimization for smaller binary
    -flto
    ; Remove unused code
    -ffunction-sections
    -fdata-sections
    ; Linker flags
    -Wl,--gc-sections
    -Wl,--relax

; Library dependencies
lib_deps = 
    coryjfowler/MCP_CAN@^1.5.1
    adafruit/Adafruit NeoPixel@^1.12.0
    mikalhart/TinyGPSPlus@^1.1.0
    arduino-libraries/SD@^1.3.0

; Upload settings
upload_protocol = arduino
upload_speed = 57600

; Show detailed memory usage after build
build_type = release

; ============================================================================
; NATIVE SIMULATION - For Logic Testing
; ============================================================================
[env:native_sim]
platform = native
build_flags = 
    -DNATIVE_SIM
    -DSIM_MODE
    -std=c++11
    -D__AVR_ATmega328P__
    ; Mock Arduino functions
    -DARDUINO=10819
    -DF_CPU=16000000L

; Simulated library dependencies
lib_deps = 
    ; Native-compatible libraries only

; Test framework
test_framework = unity
test_build_src = yes

; ============================================================================
; WOKWI SIMULATOR - Visual Hardware Simulation
; ============================================================================
[env:wokwi_sim]
platform = atmelavr
board = nanoatmega328
framework = arduino

; Wokwi-specific settings
monitor_speed = 115200
board_build.extra_flags = 
    -DWOKWI_SIM
build_flags = 
    -DWOKWI_SIM
    -DMCP2515_CRYSTAL_16MHZ

; Wokwi configuration files are in hardware/ folder
board_build.variant_dir = hardware

lib_deps = 
    coryjfowler/MCP_CAN@^1.5.1
    adafruit/Adafruit NeoPixel@^1.12.0
    mikalhart/TinyGPSPlus@^1.1.0
    arduino-libraries/SD@^1.3.0

; ============================================================================
; RELEASE BUILD - Maximum Performance (for track use)
; ============================================================================
[env:nano_release]
platform = atmelavr
board = nanoatmega328
framework = arduino
monitor_speed = 115200

; Aggressive optimization flags for maximum performance
build_flags = 
    -DARDUINO_NANO
    -DMCP2515_CRYSTAL_16MHZ
    -DRELEASE_MODE
    ; Optimize for speed
    -O3
    ; Enable all optimizations
    -flto
    -ffast-math
    -ffunction-sections
    -fdata-sections
    ; Remove asserts and debug code
    -DNDEBUG
    ; Linker optimizations
    -Wl,--gc-sections
    -Wl,--relax

lib_deps = 
    coryjfowler/MCP_CAN@^1.5.1
    adafruit/Adafruit NeoPixel@^1.12.0
    mikalhart/TinyGPSPlus@^1.1.0
    arduino-libraries/SD@^1.3.0

; ============================================================================
; DEBUG BUILD - For Serial Debugging
; ============================================================================
[env:nano_debug]
platform = atmelavr
board = nanoatmega328
framework = arduino
monitor_speed = 115200

build_flags = 
    -DDEBUG_MODE
    -DARDUINO_NANO
    -DMCP2515_CRYSTAL_16MHZ
    -g  ; Include debug symbols
    -O0 ; No optimization for debugging

lib_deps = 
    coryjfowler/MCP_CAN@^1.5.1
    adafruit/Adafruit NeoPixel@^1.12.0
    mikalhart/TinyGPSPlus@^1.1.0
    arduino-libraries/SD@^1.3.0

lib_ldf_mode = deep+

; ============================================================================
; COMMON SETTINGS
; ============================================================================
[env]
; Source directory structure (standard PlatformIO layout)
; src/ contains main application code
; lib/ contains custom libraries and modules
; All source files are automatically included from src/

; Ignore these files
lib_ignore = 
    examples
    test

; Check configuration
check_tool = cppcheck, clangtidy
check_flags = 
    cppcheck: --enable=all --suppress=unusedFunction
    clangtidy: --checks=-*,clang-analyzer-*,performance-*

; Extra scripts (optional)
; extra_scripts = 
;     pre:scripts/pre_build.py
;     post:scripts/post_build.py
